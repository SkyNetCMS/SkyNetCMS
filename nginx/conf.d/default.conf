# ============================================
# SkyNetCMS - Default Server Configuration
# ============================================

server {
    listen 80;
    server_name _;

    # ----------------------------------------
    # Health check endpoint
    # ----------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # ----------------------------------------
    # Static content from built site
    # ----------------------------------------
    location / {
        root /data/repo/dist;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # ----------------------------------------
    # Admin registration page (first-time setup)
    # Only accessible when admin not yet configured
    # ----------------------------------------
    location = /sn_admin/setup {
        return 301 /sn_admin/setup/;
    }

    location /sn_admin/setup/ {
        access_by_lua_block {
            local auth = require("auth")
            if auth.is_admin_configured() then
                -- Admin exists, redirect to main admin panel
                return ngx.redirect("/sn_admin/")
            end
            -- No admin configured, allow access to setup page
        }

        alias /opt/admin-registration/;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # ----------------------------------------
    # Registration POST handler
    # Only accessible when admin not yet configured
    # ----------------------------------------
    location = /sn_admin/register {
        # Lua handler for registration
        content_by_lua_file /etc/nginx/lua/registration.lua;
    }

    # ----------------------------------------
    # Admin panel entry point
    # Handles routing based on configuration state
    # ----------------------------------------
    location /sn_admin/ {
        # Use rewrite_by_lua to check state BEFORE auth_basic
        rewrite_by_lua_block {
            local auth = require("auth")
            if not auth.is_admin_configured() then
                -- No admin configured, redirect to setup
                return ngx.redirect("/sn_admin/setup/")
            end
            -- Admin exists, proceed with normal auth
        }

        auth_basic "SkyNetCMS Admin";
        auth_basic_user_file /data/.htpasswd;

        # Serve admin placeholder (will proxy to OpenCode in M3)
        alias /data/admin/;
        index index.html;
        try_files $uri $uri/ =404;
    }
}
