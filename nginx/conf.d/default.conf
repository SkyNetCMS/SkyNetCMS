# ============================================
# SkyNetCMS - Default Server Configuration
# ============================================

server {
    listen 80;
    server_name _;

    # ----------------------------------------
    # Health check endpoint
    # ----------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
    }

    # ----------------------------------------
    # Website assets (Vite generates hashed filenames)
    # Long cache - filename changes when content changes
    # ----------------------------------------
    location /assets/ {
        root /data/website/dist;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
    }

    # ----------------------------------------
    # Static content from built site
    # Always revalidate HTML - content changes via AI edits
    # ----------------------------------------
    location / {
        root /data/website/dist;
        index index.html;
        try_files $uri $uri/ =404;

        # Force browser to always check for fresh content
        # Server returns 304 if unchanged, 200 with new content if changed
        add_header Cache-Control "no-cache" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
    }

    # ----------------------------------------
    # Admin assets (JS, CSS, logos, favicon)
    # Publicly accessible - no auth required
    # ----------------------------------------
    location /sn_admin/assets/ {
        alias /opt/admin-ui/assets/;
        expires 7d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
    }

    # ----------------------------------------
    # Admin registration page (first-time setup)
    # Only accessible when admin not yet configured
    # ----------------------------------------
    location = /sn_admin/setup {
        return 301 /sn_admin/setup/;
    }

    location /sn_admin/setup/ {
        access_by_lua_block {
            local auth = require("auth")
            if auth.is_admin_configured() then
                -- Admin exists, redirect to main admin panel
                return ngx.redirect("/sn_admin/")
            end
            -- No admin configured, allow access to setup page
        }

        # Prevent browser caching - state may change
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;

        alias /opt/admin-ui/pages/registration/;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # ----------------------------------------
    # Registration POST handler
    # Only accessible when admin not yet configured
    # ----------------------------------------
    location = /sn_admin/register {
        # Lua handler for registration
        content_by_lua_file /etc/nginx/lua/registration.lua;
    }

    # ----------------------------------------
    # OpenCode Web UI proxy
    # Must come before /sn_admin/ to match first
    # OpenCode is started with --base-path /sn_admin/oc so it handles
    # the path prefix internally - no rewrite needed here
    # ----------------------------------------
    location /sn_admin/oc/ {
        # Check admin configuration state
        rewrite_by_lua_block {
            local auth = require("auth")
            if not auth.is_admin_configured() then
                return ngx.redirect("/sn_admin/setup/")
            end
        }

        auth_basic "SkyNetCMS Admin";
        auth_basic_user_file /data/auth/.htpasswd;

        # Prevent browser caching of API responses
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Proxy to OpenCode web server
        # OpenCode handles /sn_admin/oc/ base path internally
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;

        # WebSocket support (essential for OpenCode real-time features)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Force OpenCode to use /data/website as the working directory
        proxy_set_header X-OpenCode-Directory /data/website;

        # Extended timeouts for AI operations
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_connect_timeout 60s;

        # Disable buffering for streaming responses
        proxy_buffering off;
    }

    # ----------------------------------------
    # Dev server status API
    # Returns JSON with current dev server status and worktree info
    # ----------------------------------------
    location = /sn_admin/dev/status {
        rewrite_by_lua_block {
            local auth = require("auth")
            if not auth.is_admin_configured() then
                return ngx.redirect("/sn_admin/setup/")
            end
        }

        auth_basic "SkyNetCMS Admin";
        auth_basic_user_file /data/auth/.htpasswd;

        content_by_lua_block {
            local devserver = require("devserver")
            local worktree = require("worktree")
            local cjson = require("cjson.safe")
            
            ngx.header.content_type = "application/json"
            ngx.header["Cache-Control"] = "no-cache, no-store, must-revalidate"
            
            -- Get worktree info
            local all_worktrees = worktree.list_all()
            local current_dir = devserver.get_current_directory()
            
            ngx.say(cjson.encode({
                status = devserver.get_status(),
                last_activity = devserver.get_last_activity(),
                idle_timeout = devserver.IDLE_TIMEOUT,
                current_directory = current_dir,
                worktrees = all_worktrees
            }))
        }
    }

    # ----------------------------------------
    # Dev server on-demand proxy
    # Starts Vite dev server if not running, then proxies to it
    # Auto-shuts down after 5 minutes of inactivity
    # 
    # Worktree detection:
    # 1. Check for ?worktree=<name> query param
    # 2. Use most recently modified worktree
    # 3. Fallback to main website directory
    # ----------------------------------------
    location /sn_admin/dev/ {
        rewrite_by_lua_block {
            local auth = require("auth")
            if not auth.is_admin_configured() then
                return ngx.redirect("/sn_admin/setup/")
            end
        }

        auth_basic "SkyNetCMS Admin";
        auth_basic_user_file /data/auth/.htpasswd;

        # Dev server management - detect worktree, start if needed, wait for ready
        access_by_lua_block {
            local devserver = require("devserver")
            local worktree = require("worktree")
            
            -- Determine which directory to use
            local target_dir, worktree_name = worktree.get_dev_directory()
            
            -- Check if server needs to restart for different directory
            local status = devserver.get_status()
            if status == "running" and devserver.needs_restart(target_dir) then
                ngx.log(ngx.INFO, "dev: Worktree changed, restarting server")
                devserver.stop_server()
                status = "stopped"
            end
            
            -- Start server if not running
            if status == "stopped" then
                local ok = devserver.start_server(target_dir)
                if not ok then
                    ngx.status = 503
                    ngx.header.content_type = "text/html"
                    ngx.say("<html><body><h1>Dev Server Error</h1>")
                    ngx.say("<p>Failed to start dev server in: " .. target_dir .. "</p>")
                    ngx.say("<p>Check logs at /tmp/vite-dev.log</p>")
                    ngx.say("</body></html>")
                    return ngx.exit(503)
                end
                status = "starting"
            end
            
            -- Wait for server to be ready
            if status == "starting" then
                local ready = devserver.wait_for_ready(30)
                if not ready then
                    ngx.status = 503
                    ngx.header.content_type = "text/html"
                    ngx.say("<html><body><h1>Dev Server Timeout</h1>")
                    ngx.say("<p>Dev server did not start in time.</p>")
                    ngx.say("<p>Directory: " .. target_dir .. "</p>")
                    ngx.say("<p>Check logs at /tmp/vite-dev.log</p>")
                    ngx.say("<p><a href='/sn_admin/dev/'>Try again</a></p>")
                    ngx.say("</body></html>")
                    return ngx.exit(503)
                end
            end
            
            -- Update activity timestamp
            devserver.update_activity()
        }

        # Prevent caching
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Proxy to Vite dev server
        # Vite is started with --base /sn_admin/dev/ so paths match
        proxy_pass http://127.0.0.1:5173;
        proxy_http_version 1.1;

        # WebSocket support for Vite HMR
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_connect_timeout 10s;

        # Disable buffering for HMR streaming
        proxy_buffering off;
    }

    # ----------------------------------------
    # Admin dashboard catch-all
    # IMPORTANT: This MUST be the LAST /sn_admin/* location block
    # because it uses prefix matching. More specific locations
    # (/sn_admin/setup/, /sn_admin/oc/, etc.) must come before this.
    # ----------------------------------------
    location /sn_admin/ {
        # Use rewrite_by_lua to check state BEFORE auth_basic
        rewrite_by_lua_block {
            local auth = require("auth")
            if not auth.is_admin_configured() then
                -- No admin configured, redirect to setup
                return ngx.redirect("/sn_admin/setup/")
            end
            -- Admin exists, proceed with normal auth
        }

        auth_basic "SkyNetCMS Admin";
        auth_basic_user_file /data/auth/.htpasswd;

        # Prevent browser caching - state may change
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Serve admin dashboard SPA
        alias /opt/admin-ui/pages/dashboard/;
        index index.html;
    }
}
