# ============================================
# SkyNetCMS - Default Server Configuration
# ============================================

server {
    listen 80;
    server_name _;

    # ----------------------------------------
    # Health check endpoint
    # ----------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # ----------------------------------------
    # Static content from built site
    # ----------------------------------------
    location / {
        root /data/repo/dist;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # ----------------------------------------
    # Admin registration page (first-time setup)
    # Only accessible when admin not yet configured
    # ----------------------------------------
    location = /sn_admin/setup {
        return 301 /sn_admin/setup/;
    }

    location /sn_admin/setup/ {
        access_by_lua_block {
            local auth = require("auth")
            if auth.is_admin_configured() then
                -- Admin exists, redirect to main admin panel
                return ngx.redirect("/sn_admin/")
            end
            -- No admin configured, allow access to setup page
        }

        # Prevent browser caching - state may change
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        alias /opt/admin-registration/;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # ----------------------------------------
    # Registration POST handler
    # Only accessible when admin not yet configured
    # ----------------------------------------
    location = /sn_admin/register {
        # Lua handler for registration
        content_by_lua_file /etc/nginx/lua/registration.lua;
    }

    # ----------------------------------------
    # OpenCode Web UI proxy
    # Must come before /sn_admin/ to match first
    # OpenCode is started with --base-path /sn_admin/oc so it handles
    # the path prefix internally - no rewrite needed here
    # ----------------------------------------
    location /sn_admin/oc/ {
        # Check admin configuration state
        rewrite_by_lua_block {
            local auth = require("auth")
            if not auth.is_admin_configured() then
                return ngx.redirect("/sn_admin/setup/")
            end
        }

        auth_basic "SkyNetCMS Admin";
        auth_basic_user_file /data/auth/.htpasswd;

        # Prevent browser caching of API responses
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # Proxy to OpenCode web server
        # OpenCode handles /sn_admin/oc/ base path internally
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;

        # WebSocket support (essential for OpenCode real-time features)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Force OpenCode to use /data/repo as the working directory
        proxy_set_header X-OpenCode-Directory /data/repo;

        # Extended timeouts for AI operations
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_connect_timeout 60s;

        # Disable buffering for streaming responses
        proxy_buffering off;
    }

    # ----------------------------------------
    # Admin dashboard catch-all
    # IMPORTANT: This MUST be the LAST /sn_admin/* location block
    # because it uses prefix matching. More specific locations
    # (/sn_admin/setup/, /sn_admin/oc/, etc.) must come before this.
    # ----------------------------------------
    location /sn_admin/ {
        # Use rewrite_by_lua to check state BEFORE auth_basic
        rewrite_by_lua_block {
            local auth = require("auth")
            if not auth.is_admin_configured() then
                -- No admin configured, redirect to setup
                return ngx.redirect("/sn_admin/setup/")
            end
            -- Admin exists, proceed with normal auth
        }

        auth_basic "SkyNetCMS Admin";
        auth_basic_user_file /data/auth/.htpasswd;

        # Prevent browser caching - state may change
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # Serve admin dashboard SPA
        # alias replaces the matched location prefix with the specified path
        alias /opt/admin-dashboard/;
        index index.html;
    }
}
